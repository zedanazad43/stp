#!/bin/bash

# 1. CONFIGURATION
# ----------------
# Define the directory where you want to clone all repos
WORK_DIR="$HOME/github_repos_audit"
# Define your GitHub username
USERNAME="YOUR_GITHUB_USERNAME" # REPLACE THIS WITH YOUR USERNAME
# Define the name of the branch to create for fixes
FIX_BRANCH="workflow-unification"

# Create working directory
mkdir -p "$WORK_DIR"
cd "$WORK_DIR"

echo "üöÄ Starting repository audit for user: $USERNAME"

# 2. FETCH REPOSITORIES
# ---------------------
echo "üì• Fetching list of repositories..."
# Get list of repo names (skipping forks and archived repos for safety)
REPOS=$(gh repo list $USERNAME --limit 1000 --json name,isFork,archived --jq '.[] | select(.isFork == false and .archived == false) | .name')

for REPO in $REPOS; do
    echo "------------------------------------------------"
    echo "Processing Repository: $REPO"
    
    # Clone or update the repository
    if [ -d "$REPO" ]; then
        echo "‚úÖ Repository exists. Pulling latest changes..."
        cd "$REPO"
        git fetch origin
        git checkout main 2>/dev/null || git checkout master 2>/dev/null
        git pull origin main 2>/dev/null || git pull origin master 2>/dev/null
        cd ..
    else
        echo "‚¨áÔ∏è Cloning repository..."
        gh repo clone "$USERNAME/$REPO"
    fi

    cd "$REPO"

    # 3. BRANCH MANAGEMENT & CONFLICT RESOLUTION
    # -------------------------------------------
    # Check if the fix branch exists locally
    if git show-ref --verify --quiet refs/heads/"$FIX_BRANCH"; then
        echo "üîÄ Branch '$FIX_BRANCH' exists. Checking it out..."
        git checkout "$FIX_BRANCH"
        
        # Try to rebase onto main/master to get latest changes and detect conflicts early
        echo "üîÑ Rebasing '$FIX_BRANCH' onto main/master..."
        git rebase main 2>/dev/null || git rebase master 2>/dev/null
        
        if [ $? -ne 0 ]; then
            echo "‚ö†Ô∏è CONFLICT DETECTED during rebase in $REPO."
            echo "Please resolve conflicts manually in $WORK_DIR/$REPO"
            echo "Run 'git rebase --continue' after fixing."
        else
            echo "‚úÖ Rebase successful."
        fi
    else
        echo "üåø Creating new branch '$FIX_BRANCH' from main/master..."
        git checkout main 2>/dev/null || git checkout master 2>/dev/null
        git checkout -b "$FIX_BRANCH"
    fi

    # 4. UNIFY WORKFLOWS (INTEGRATION)
    # --------------------------------
    # Ensure the directory exists
    mkdir -p .github/workflows

    # Check if main.yml exists
    if [ -f ".github/workflows/main.yml" ]; then
        echo "üìÑ Existing main.yml found. Backing up to main.yml.backup..."
        mv .github/workflows/main.yml .github/workflows/main.yml.backup
    fi

    # CREATE THE STANDARD WORKFLOW FILE
    # Note: You should replace the content below with your specific "Golden Template"
    echo "üìù Writing unified main.yml..."
    cat <<EOF > .github/workflows/main.yml
name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

permissions:
  contents: read

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Run a one-line script
      run: echo Hello from unified workflow!
EOF

    # 5. COMMIT AND PUSH
    # -------------------
    git add .github/workflows/main.yml
    if [ -f ".github/workflows/main.yml.backup" ]; then
        git add .github/workflows/main.yml.backup
    fi

    if git diff --staged --quiet; then
        echo "‚ÑπÔ∏è No changes to commit in $REPO."
    else
        echo "üíæ Committing changes..."
        git commit -m "chore: unify workflow and resolve conflicts"
        echo "‚¨ÜÔ∏è Pushing to origin..."
        git push -u origin "$FIX_BRANCH" --force-with-lease # Force push is often needed after rebase
    fi

    cd "$WORK_DIR"
done

echo "------------------------------------------------"
echo "‚ú® Audit complete!"
echo "Check $WORK_DIR for repositories that had conflicts."
