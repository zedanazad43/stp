# Minimal job to normalize SARIF produced by codeql-action/analyze and upload it.
# Add these steps after the analyze step in your existing CodeQL workflow (or use as a separate job that runs after analyze).
on: workflow_run
jobs:
  normalize-and-upload:
    runs-on: ubuntu-latest
    needs: [codeql-analysis] # update to the job name that runs CodeQL analyze
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch SARIF artifact (if analyze stored it in workspace)
        # If your analyze step outputs the SARIF to the workspace, skip this.
        # Otherwise, download or copy the SARIF to ./results/javascript.sarif
        run: |
          mkdir -p results
          # adjust path if CodeQL wrote to a different location:
          # cp /home/runner/work/Stampcoin-platform/results/javascript.sarif results/javascript.sarif || true

      - name: Normalize SARIF paths
        run: |
          INPUT=results/javascript.sarif
          OUTPUT=results/javascript.fixed.sarif
          jq 'def normalize_string:(gsub("\\\\+"; "/")|sub("^[A-Za-z]:/"; "")); def fix: if type=="object" then with_entries(.value |= fix) elif type=="array" then map(fix) elif type=="string" then normalize_string else . end; fix' "$INPUT" > "$OUTPUT"
          echo "Normalized SARIF saved to $OUTPUT"

      - name: Upload normalized SARIF
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: results/javascript.fixed.sarif