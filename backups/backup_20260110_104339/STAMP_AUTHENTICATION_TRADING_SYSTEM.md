# نظام توثيق وتداول الطوابع الشامل
## Comprehensive Stamp Authentication & Trading System

---

## المقدمة

تم بناء نظام متكامل لتوثيق الطوابع وتحويلها إلى NFT مع إمكانية تداولها رقمياً أو فيزيائياً من خلال منصة آمنة تدعم نظام الرصيد الاحتياطي (Escrow) والشحن والفواتير.

## الميزات الرئيسية

### 1. نظام التوثيق والعملات (Authentication & Tokenization)

#### آلية العمل:
1. مالك الطابع يرفع صورة عالية الجودة للطابع
2. يحدد تفاصيل الطابع (الدولة، السنة، الندرة، الحالة)
3. يتم حساب القيمة المقدرة بناءً على معايير الندرة والحالة
4. يتم حساب الرسوم تلقائياً:
   - **رسم التوثيق**: 5% من القيمة المقدرة (بحد أدنى $5، حد أقصى $1000)
   - **رسم سك NFT**: $10
   - **رسم التخزين الشهري**: $2

#### الرسوم:
```
مثال: طابع بقيمة $500
- رسم التوثيق (5%): $25
- رسم السك: $10
- رسم التخزين: $2
الإجمالي: $37

القيمة بعملة الموقع: 50,000 STAMP_COIN (1:100)
```

#### العملية التقنية:
- الصورة تُرفع إلى IPFS عبر Pinata
- NFT يُسك على شبكة Polygon
- السجل يُحفظ في قاعدة البيانات مع رقم الشهادة الفريد

### 2. نظام التداول الثنائي (Dual Trading System)

#### أنواع التداول:
1. **تداول NFT فقط**: نقل الملكية الرقمية فوراً
2. **تداول الطابع المادي**: شحن فيزيائي مع تتبع
3. **التداول المدمج**: NFT + الطابع المادي معاً

#### عملية التداول:
```
1. البائع ينشئ قائمة (Listing)
   - نوع التداول (NFT/مادي/كلاهما)
   - الأسعار المطلوبة
   - وصف وتفاصيل إضافية

2. المشتري يعرض تداول (Trade Offer)
   - حساب المبلغ الإجمالي
   - إنشاء حساب رصيد احتياطي
   - الأموال تُحفظ احتياطياً

3. البائع يوافق
   - التوقيع الرقمي من البائع
   - تأكيد المعلومات

4. المشتري يؤكد
   - التوقيع الرقمي من المشتري
   - بدء الشحن (في حالة التداول المادي)

5. التسليم والإكمال
   - تسليم الطابع المادي (إن وجد)
   - نقل NFT (إن وجد)
   - إفراج عن الأموال للبائع
   - إغلاق المعاملة
```

#### الرسوم:
```
رسم المنصة: 5% من سعر البيع
رسوم الشحن: حسب الشركة (افتراضي: $50)
تأمين الشحن: حسب القيمة (افتراضي: $10)
```

### 3. نظام الرصيد الاحتياطي (Escrow System)

#### الغرض:
- حماية كلا الطرفين (المشتري والبائع)
- منع الاحتيال والمعاملات غير الآمنة
- توفير آلية فض النزاعات

#### آلية الحفظ الاحتياطي:
```
عند تقبل المشتري للعرض:
┌─────────────────────────────┐
│  حساب الرصيد الاحتياطي      │
│  ┌───────────────────────┐  │
│  │ المبلغ المحتفظ به     │  │
│  │ = السعر + الرسوم      │  │
│  │ = $500 + $25 + $10    │  │
│  │ = $535                │  │
│  └───────────────────────┘  │
│                             │
│  الحالة: محتفظ به (HELD)   │
└─────────────────────────────┘
         ↓
   (بعد التسليم)
         ↓
    إفراج عن الأموال
    - البائع: $507.25 (95%)
    - المنصة: $26.75 (5%)
```

#### حالات الحفظ الاحتياطي:
1. **محتفظ به (HELD)**: في انتظار إتمام المعاملة
2. **مُفرج عنه للبائع (RELEASED_TO_SELLER)**: تم التسليم بنجاح
3. **مُرتجع للمشتري (REFUNDED_TO_BUYER)**: تم إلغاء المعاملة
4. **مختلف عليه (DISPUTED)**: فتح نزاع

### 4. نظام الشحن والتتبع (Shipping & Tracking)

#### معلومات الشحن المسجلة:
- شركة الشحن
- رقم المتابعة
- تاريخ الشحن
- موعد التسليم المتوقع
- تاريخ التسليم الفعلي
- إثبات التسليم

#### حالات الشحن:
- **في الانتظار** (PENDING)
- **قيد النقل** (IN_TRANSIT)
- **تم التسليم** (DELIVERED) ✅
- **مفقود** (LOST) ❌
- **تالف** (DAMAGED) ⚠️
- **مُرتجع** (RETURNED)

#### تتبع الشحنة:
```
المستخدمون يمكنهم تتبع الشحنات من خلال:
1. رقم المتابعة
2. لوحة التحكم الشخصية
3. إشعارات الحالة الفورية
4. معلومات المرسل والمستقبل
5. إثبات التسليم
```

### 5. نظام الفواتير والوثائق (Invoicing System)

#### بيانات الفاتورة:
```
رقم الفاتورة: INV-[التاريخ]-[رقم عشوائي]
مثال: INV-1735689600000-AB3XK7F9Q

التفاصيل:
- وصف المنتج
- الكمية والسعر الفردي
- رسوم المنصة (5%)
- تكاليف الشحن
- تأمين الشحن
- الضريبة
- الإجمالي
```

#### حالات الفاتورة:
- **مسودة** (DRAFT)
- **صادرة** (ISSUED)
- **مدفوعة** (PAID) ✅
- **متأخرة** (OVERDUE)
- **ملغاة** (CANCELLED)

#### الميزات:
- تحميل بصيغة PDF
- تتبع حالة الدفع
- إشعارات تلقائية

### 6. نظام فض النزاعات (Dispute Resolution)

#### أسباب النزاع:
1. **المنتج لم يُستقبل** (ITEM_NOT_RECEIVED)
2. **المنتج تالف** (ITEM_DAMAGED)
3. **المنتج لا يطابق الوصف** (ITEM_NOT_AS_DESCRIBED)
4. **معاملة غير مصرح بها** (UNAUTHORIZED_TRANSACTION)
5. **أسباب أخرى** (OTHER)

#### عملية الفض:
```
1. المشتاكي يفتح نزاع
   - تحديد السبب
   - وصف المشكلة
   - إرسال أدلة

2. المنصة تراجع النزاع
   - فحص الوثائق
   - اتصال بالأطراف
   - جمع البينات

3. اتخاذ القرار
   - استرجاع الأموال
   - فض النزاع
   - تطبيق العقوبات

4. التنفيذ
   - إفراج/ارتجاع الأموال
   - إغلاق المعاملة
```

---

## الواجهات الرئيسية

### صفحة توثيق الطابع (`/authenticate-stamp`)
```
الخطوات:
1. إدخال معلومات الطابع
   - الاسم والدولة والسنة
   - رقم الكتالوج
   - الحالة والندرة

2. رفع الصورة
   - معاينة قبل الرفع
   - التحقق من جودة الصورة

3. عرض الرسوم
   - رسم التوثيق
   - رسم السك
   - رسم التخزين
   - الإجمالي

4. تأكيد التوثيق
   - الموافقة على الشروط
   - الدفع
   - الحصول على رقم الشهادة
```

### سوق التداول (`/trading`)
```
الميزات:
- عرض قوائم النشطة
- تصفية حسب النوع (NFT/مادي/كلاهما)
- عرض عرض للشراء
- تتبع المعاملة
- التاريخ الكامل
```

### لوحة الرصيد الاحتياطي (`/escrow`)
```
العرض:
- الرصيد الإجمالي
- الرصيد المتاح
- الأموال المحتفظ بها
- السجل المالي
- تفاصيل المعاملات
```

### تتبع الشحن (`/shipping`)
```
الخدمات:
- بحث برقم المتابعة
- عرض معلومات الشحن
- تتبع الحالة
- عرض الفواتير
- تحميل الوثائق
```

---

## الهيكل التقني

### قاعدة البيانات

#### جداول رئيسية:
1. **authenticated_stamps**: سجل الطوابع الموثقة
2. **stamp_listings**: قوائم البيع
3. **stamp_trades**: المعاملات
4. **escrow_accounts**: حسابات الرصيد الاحتياطي
5. **user_reserve_balance**: رصيد المستخدم
6. **balance_transactions**: سجل المعاملات المالية
7. **shipping_records**: سجلات الشحن
8. **invoices**: الفواتير
9. **disputes**: النزاعات

### API Endpoints

#### التوثيق:
- `POST /trpc/stampAuth.createStamp` - إنشاء طابع جديد
- `POST /trpc/stampAuth.uploadStampImage` - رفع الصورة
- `POST /trpc/stampAuth.verifyStamp` - التحقق من الطابع
- `GET /trpc/stampAuth.getStamp` - الحصول على تفاصيل الطابع
- `GET /trpc/stampAuth.getUserStamps` - طوابع المستخدم
- `GET /trpc/stampAuth.searchStamps` - البحث عن الطوابع
- `GET /trpc/stampAuth.calculateFees` - حساب الرسوم

#### التداول:
- `POST /trpc/trading.createListing` - إنشاء قائمة
- `GET /trpc/trading.getListings` - الحصول على القوائم
- `POST /trpc/trading.acceptTrade` - قبول عرض تداول
- `POST /trpc/trading.approveTrade` - موافقة البائع
- `POST /trpc/trading.approveBuyerTrade` - موافقة المشتري
- `GET /trpc/trading.getTrade` - تفاصيل المعاملة
- `GET /trpc/trading.getUserTrades` - معاملات المستخدم
- `POST /trpc/trading.completeTrade` - إتمام المعاملة
- `POST /trpc/trading.openDispute` - فتح نزاع
- `GET /trpc/trading.getReserveBalance` - الرصيد الاحتياطي
- `GET /trpc/trading.getTransactionHistory` - السجل المالي

#### الشحن:
- `POST /trpc/shipping.createShippingRecord` - إنشاء سجل شحن
- `GET /trpc/shipping.getShippingDetails` - معلومات الشحن
- `GET /trpc/shipping.trackShipment` - تتبع الشحنة
- `POST /trpc/shipping.updateShippingStatus` - تحديث الحالة
- `GET /trpc/shipping.getTradeShipments` - شحنات المعاملة
- `POST /trpc/shipping.createInvoice` - إنشاء فاتورة
- `GET /trpc/shipping.getInvoice` - تفاصيل الفاتورة
- `GET /trpc/shipping.getTradeInvoices` - فواتير المعاملة
- `POST /trpc/shipping.updateInvoiceStatus` - تحديث حالة الفاتورة
- `GET /trpc/shipping.getUserInvoices` - فواتير المستخدم
- `GET /trpc/shipping.generateInvoicePDF` - تنزيل PDF

---

## الأمان والحماية

### إجراءات الأمان:
1. **التوقيع الرقمي**: كل معاملة يجب أن توقعها الأطراف
2. **الرصيد الاحتياطي**: حماية المشتري والبائع
3. **التشفير**: معلومات المستخدم والدفع
4. **التحقق من الهوية**: قبل المعاملات الكبيرة
5. **مراقبة الاحتيال**: كشف المعاملات المريبة

### الامتثال:
- **GDPR**: حماية البيانات الشخصية
- **PCI DSS**: معايير الدفع
- **AML/KYC**: مكافحة غسل الأموال

---

## التطور المستقبلي

### المراحل القادمة:
1. **التكامل مع البوابات الدفعية**: PayPal، Google Pay
2. **نظام التقييمات**: تقييم البائع والمشتري
3. **برنامج الولاء**: نقاط المكافآت والخصومات
4. **التأمين**: تأمين ضد الفقدان أو الضرر
5. **عقود ذكية محسنة**: أتمتة أكثر للعمليات

---

## الدعم والمساعدة

### قنوات الدعم:
- البريد الإلكتروني: support@stampcoin.com
- الدردشة الحية: 24/7 على الموقع
- مركز المساعدة: FAQ وأدلة فيديو
- المنتدى المجتمعي: النقاشات بين المستخدمين

---

**آخر تحديث**: 2024
**الإصدار**: 1.0
**اللغة**: العربية والإنجليزية
